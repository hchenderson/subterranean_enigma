rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ---------- Helpers ----------
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isSignedIn() && request.auth.token.firebase.sign_in_provider != "anonymous";
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isCreatingOwnAdminDoc(adminId) {
      return request.resource.data.id == adminId;
    }

    function isAdminDocImmutable() {
      return request.resource.data.id == resource.data.id;
    }

    function isCreatingOwnParticipantDoc(participantId) {
      return request.resource.data.id == participantId;
    }

    function isParticipantDocImmutable() {
      return request.resource.data.id == resource.data.id;
    }

    function isCreatingValidGameState(participantId) {
      return request.resource.data.participantUserId == participantId;
    }

    function isGameStateImmutable() {
      return request.resource.data.participantUserId == resource.data.participantUserId;
    }

    // ---------- /admins ----------

    match /admins/{adminId} {
      allow get, update, delete: if isOwner(adminId);
      allow create: if isOwner(adminId) && isCreatingOwnAdminDoc(adminId);
      allow list: if false;
    }

    // ---------- /games + /games/{gameId}/generatedCodes ----------

    match /games/{gameId} {
      // Admin access to the game document itself
      allow get, list, create, update, delete: if isAdmin();

      // Join codes live here: /games/{gameId}/generatedCodes/{codeId}
      match /generatedCodes/{codeId} {
        // Anyone can read codes (for login lookup via collectionGroup)
        allow read: if true;

        // Only admins can create/update/delete codes
        allow write: if isAdmin();
      }

      // Other nested collections (hints, materials, etc.) â€“ admin only
      match /hints/{hintId} {
        allow read, write: if isAdmin();
      }
      match /materials/{materialId} {
        allow read, write: if isAdmin();
      }
      match /teamHints/{teamHintId} {
        allow read, write: if isAdmin();
      }
    }

    // ---------- /participants (profile + gameState) ----------

    match /participants/{participantId} {
      // Each user can see & manage their own participant profile
      allow get, update, delete: if isOwner(participantId);
      allow create: if isOwner(participantId) && isCreatingOwnParticipantDoc(participantId);
      allow list: if isAdmin(); // keep this if you want admin analytics

      match /gameState/{gameStateId} {
        allow get, list, update, delete: if isOwner(participantId);
        allow create: if isOwner(participantId) && isCreatingValidGameState(participantId);
      }
    }
  }
}
